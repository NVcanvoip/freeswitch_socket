# Справочник по JSON-сообщениям для `fs_custom_v2`

Этот документ описывает, как `fs_custom_v2` обменивается управляющими JSON-сообщениями с удалённым WebSocket-сервисом. Рассматриваются только структурированные сообщения (не аудио), которые сопровождают каждый звонок.

## 1. Рукопожатие и готовность

1. **Deepgram отправляет `ready_to_greet`.**
   ```json
   {
     "type": "ready_to_greet",
     "timestamp": 1700000000
   }
   ```
   *Сообщает, что удалённый ассистент готов начать диалог.*

2. **Мы отвечаем подтверждением.**
   ```json
   {
     "type": "acknowledgment",
     "command": "ready_to_greet",
     "command_timestamp": 1700000000,
     "status": "success",
     "timestamp": 1700000001
   }
   ```
   *Разрешает поток аудио и завершает ожидание готовности. Повторные подтверждения не отправляются.*

3. **Далее могут приходить `response`.**
   ```json
   {
     "response": {
       "type": "transcript",
       "channel": { "alternatives": [ { "transcript": "Здравствуйте" } ] },
       "is_final": true
     }
   }
   ```
   *Это обновления распознавания речи. Они логируются для контроля и не требуют ответа.*

## 2. Команды, которые мы принимаем

| `type` команды | Назначение | Основные поля | Результат |
| --- | --- | --- | --- |
| `clear` | Очистить буфер исходящих аудиокадров. | `timestamp` (опционально) | Очищает очередь и отправляет подтверждение с дополнительным сообщением. |
| `transfer` | Перевести абонента на другой номер. | `timestamp`, `destination`, дополнительные параметры маршрутизации (таймауты, внешний шлюз). | Проверяет данные, ставит стриминг на паузу, запускает мост, уведомляет Deepgram подтверждениями и отправляет `hangup`, если сессия завершается. |
| `end_call` | Попросить немедленно завершить звонок. | `timestamp` (опционально) | Сливает оставшееся аудио, отправляет подтверждение, завершает вызов и проводит очистку. |

Каждая команда получает стандартный конверт подтверждения, показанный ниже. При ошибках (например, нет назначения) поле `status` становится `error`, а `message` содержит текст диагностики.

```json
{
  "type": "acknowledgment",
  "command": "transfer",
  "command_timestamp": 1700000002,
  "status": "error",
  "message": "missing destination",
  "timestamp": 1700000003
}
```

## 3. Исходящие уведомления

### 3.1 События жизненного цикла вызова

Канал сообщает удалённой стороне о ключевых изменениях состояния. Повторы не допускаются.

- **Вызов принят**
  ```json
  {
    "type": "call_event",
    "event": "answered",
    "timestamp": 1700000001
  }
  ```

- **Вызов завершён**
  ```json
  {
    "type": "call_event",
    "event": "hangup",
    "reason": "NORMAL_CLEARING",
    "timestamp": 1700000100
  }
  ```
  При успешном переводе `hangup` отправляется до закрытия WebSocket, чтобы ассистент знал о завершении исходной сессии.

### 3.2 Административные подтверждения

Все подтверждения имеют единую структуру:

```json
{
  "type": "acknowledgment",
  "command": "clear",
  "command_timestamp": 1700000005,
  "status": "success",
  "message": "custom message",
  "timestamp": 1700000006
}
```

- `command` повторяет тип принятой команды.
- `command_timestamp` копирует отметку времени отправителя, либо заполняется моментом получения.
- `status` равен `success`, если валидация и выполнение прошли без ошибок.
- `message` опционально и используется для человекочитаемых комментариев.

## 4. Типовая хронология звонка

1. FreeSWITCH подключается к удалённому сервису и ждёт `ready_to_greet`.
2. После подтверждения готовности начинается передача PCM-кадров.
3. В ходе разговора ассистент может присылать промежуточные `response` с транскриптами. Они информативны и не требуют действий.
4. Для изменения состояния вызова ассистент отправляет `clear`, `transfer` или `end_call`. Каждое сообщение получает подтверждение с результатом.
5. Канал посылает `call_event` с событиями `answered` и `hangup`, чтобы синхронизировать состояние на стороне ассистента.
6. Когда сессия завершается — через `end_call`, перевод или внутренний `hangup` FreeSWITCH — выполняется очистка, поток аудио останавливается, WebSocket закрывается.

Этот справочник даёт интеграторам форматы полезной нагрузки и порядок действий, необходимый для настройки и диагностики JSON-уровня `fs_custom_v2`.
